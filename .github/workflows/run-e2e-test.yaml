name: Maestro E2E on BrowserStack

on:
  workflow_dispatch:
    inputs:
      browserstack_app_id:
        description: "BrowserStack App ID (bs://...)"
        type: string
        required: true
      browserstack_suite_id:
        description: "BrowserStack Maestro Suite ID (bs://...), leave empty to zip & upload"
        type: string
        required: false
        default: ""
      generate_allure:
        description: "Generate Allure report"
        type: boolean
        required: false
        default: true
      send_slack:
        description: "Send Slack notification"
        type: boolean
        required: false
        default: true

env:
  BSTACK_DEVICES: "Google Pixel 7-13.0"
  BSTACK_PROJECT: "Maestro E2E"
  BSTACK_BUILD_NAME: "E2E Run - ${{ github.ref_name }} @ ${{ github.run_number }}"

jobs:
  maestro-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify BrowserStack secrets
        run: |
          test -n "${{ secrets.BROWSERSTACK_USERNAME }}" || { echo "Missing secret: BROWSERSTACK_USERNAME"; exit 1; }
          test -n "${{ secrets.BROWSERSTACK_ACCESS_KEY }}" || { echo "Missing secret: BROWSERSTACK_ACCESS_KEY"; exit 1; }
        shell: bash

      # --- Zip only allowed types, exclude meta folders ---
      - name: Prepare suite zip when suite ID is not provided
        id: zip_suite
        if: ${{ inputs.browserstack_suite_id == '' }}
        run: |
          set -euo pipefail
          ZIP_NAME="maestro_flows.zip"
          rm -f "$ZIP_NAME"

          TMP_DIR="$(mktemp -d)"
          rsync -a --prune-empty-dirs \
            --include='*/' \
            --include='*.yaml' --include='*.yml' \
            --include='*.js' \
            --include='*.png' --include='*.jpg' --include='*.jpeg' --include='*.gif' \
            --include='*.mp4' \
            --exclude='.github/***' \
            --exclude='.maestro/***' \
            --exclude='LICENSE' --exclude='LICENCE' --exclude='README.md' \
            --exclude='*' \
            ./ "$TMP_DIR/"

          echo "== Suite contents =="
          (cd "$TMP_DIR" && find . -type f | sort)

          ( cd "$TMP_DIR" && zip -qr "$GITHUB_WORKSPACE/$ZIP_NAME" . )
          echo "zip_path=$ZIP_NAME" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Upload suite ZIP artifact
        if: ${{ inputs.browserstack_suite_id == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: maestro_flows_zip
          path: ${{ steps.zip_suite.outputs.zip_path }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload suite zip to BrowserStack (if needed)
        id: upload_suite
        if: ${{ inputs.browserstack_suite_id == '' }}
        env:
          BS_USER: ${{ secrets.BROWSERSTACK_USERNAME }}
          BS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          set -euo pipefail
          RAW_ID="${{ github.repository }}-${{ github.ref_name }}-${{ github.run_id }}"
          CUSTOM_ID="$(echo "$RAW_ID" | tr '[:space:]' '_' | sed 's/[^A-Za-z0-9._-]/_/g')"

          RESP=$(curl -sS -u "$BS_USER:$BS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-automate/maestro/v2/test-suite" \
            -F "file=@${{ steps.zip_suite.outputs.zip_path }}" \
            -F "custom_id=$CUSTOM_ID")
          echo "$RESP"

          SUITE_URL=$(echo "$RESP" | jq -r '.test_suite_url')
          SUITE_ID=$(echo "$RESP" | jq -r '.test_suite_id')
          test "$SUITE_URL" != "null"
          echo "suite_url=$SUITE_URL" >> "$GITHUB_OUTPUT"
          echo "suite_id=$SUITE_ID"   >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Resolve suite URL
        id: suite_url
        run: |
          if [ -n "${{ inputs.browserstack_suite_id }}" ]; then
            echo "value=${{ inputs.browserstack_suite_id }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${{ steps.upload_suite.outputs.suite_url }}" >> "$GITHUB_OUTPUT"
          fi
        shell: bash

      # --- Whitelist root tests only (prevent subflows from being executed) ---
      - name: Build tests whitelist (root *.yml/*.yaml only)
        id: whitelist
        shell: bash
        run: |
          set -euo pipefail

          # collect only top-level *.yml / *.yaml (no subfolders)
          shopt -s nullglob nocaseglob
          ROOT_TESTS=( *.yml *.yaml )
          shopt -u nocaseglob

          echo "Selected tests:"
          for f in "${ROOT_TESTS[@]}"; do
            echo " - $f"
          done

          # fail early if nothing found
          if ((${#ROOT_TESTS[@]} == 0)); then
            echo "No root-level tests (*.yml/*.yaml) found." >&2
            exit 1
          fi

          # 1) newline-delimited list (safe for GitHub Actions)
          {
            echo 'tests<<EOF'
            for f in "${ROOT_TESTS[@]}"; do
              echo "$f"
            done
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

          # 2) JSON array (useful for debugging or future API calls)
          printf -v JSON '%s' "$(printf '"%s",' "${ROOT_TESTS[@]}" | sed 's/,$//')"
          echo "tests_json=[${JSON}]" >> "$GITHUB_OUTPUT"

      - name: Wait for build to finish
        id: wait_build
        env:
          BS_USER: ${{ secrets.BROWSERSTACK_USERNAME }}
          BS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BUILD_ID: ${{ steps.start_build.outputs.build_id }}
        run: |
          set -euo pipefail
          ATTEMPTS=720
          SLEEP=10
          STATUS="running"
          mkdir -p artifacts
          for i in $(seq 1 $ATTEMPTS); do
            RESP=$(curl -sS -u "$BS_USER:$BS_KEY" \
              -X GET "https://api-cloud.browserstack.com/app-automate/maestro/v2/builds/$BUILD_ID")
            STATUS=$(echo "$RESP" | jq -r '.status')
            echo "[$(date -u +%H:%M:%S)] Build $BUILD_ID status: $STATUS"
            echo "$RESP" > "artifacts/build-$BUILD_ID.json"
            if [[ "$STATUS" =~ ^(passed|failed|error|stopped|timedout)$ ]]; then
              break
            fi
            sleep $SLEEP
          done
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Upload BrowserStack build JSON
        uses: actions/upload-artifact@v4
        with:
          name: browserstack-build
          path: artifacts/build-*.json
          if-no-files-found: ignore
          retention-days: 7
